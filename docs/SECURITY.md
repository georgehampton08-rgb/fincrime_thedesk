# Security — FinCrime: The Desk

> FinCrime: The Desk is a local, single-player desktop simulation. This document defines the trust model, attack surfaces, and recommended mitigations appropriate to that context — and flags items that become critical if a multiplayer or networked mode is ever added.

---

## Trust Boundaries

```
┌─────────────────────────────────────────────────┐
│  TRUST ZONE A: Player / Godot UI                │
│  • Keyboard / mouse input                       │
│  • Button presses → PlayerCommand values        │
│  • Constraint: only predefined command types    │
└──────────────┬──────────────────────────────────┘
               │ stdin pipe (ProcessStartInfo)
               │ BOUNDARY 1: IPC message parsing
┌──────────────▼──────────────────────────────────┐
│  TRUST ZONE B: sim-runner.exe bridge            │
│  • Deserializes IPC JSON                        │
│  • Dispatches to engine methods                 │
└──────────────┬──────────────────────────────────┘
               │ Rust function calls (in-process)
               │ BOUNDARY 2: Config / SQL layer
┌──────────────▼──────────────────────────────────┐
│  TRUST ZONE C: fincrime-core (Rust lib)         │
│  • SimEngine, SimStore, subsystems               │
│  • All SQL is parameterized via rusqlite         │
└──────────────┬──────────────────────────────────┘
               │ rusqlite (bundled SQLite)
               │ BOUNDARY 3: Filesystem
┌──────────────▼──────────────────────────────────┐
│  TRUST ZONE D: SQLite database + config files   │
│  • Local filesystem, owner = player             │
│  • data/*.json config files                     │
└─────────────────────────────────────────────────┘
```

---

## Attack Surfaces

### 1. IPC Message Parsing (Boundary 1)

**Surface:** `serde_json::from_str()` on stdin input in `tools/src/main.rs:108`.

**Risk:** Crafted JSON that causes unexpected behavior in `handle_command()`. Currently, unknown `cmd` values are silently dropped with `log::warn!`. A malicious or corrupt message cannot escape the process — it is never forwarded to a network.

**Mitigations in place:**

- `IpcCommand` is a closed enum with `#[serde(tag = "type")]` — unrecognized `type` values produce a parse error, which is returned as `{"error": "..."}` without crashing
- The IPC loop continues after parse errors (`continue`)

**Recommendation:** Return a structured `{"error": "unknown_command", "cmd": "..."}` for dispatched but unimplemented commands rather than a silent `warn!`.

### 2. Config Injection (Boundary 2—Filesystem)

**Surface:** `data/*.json` config files loaded via `SimConfig::load()` at startup.

**Risk:** A tampered config file (e.g., `discount_rate_annual: -999`) could cause numeric overflows, division-by-zero, or unexpected simulation behavior.

**Mitigations in place:**

- `serde_json` produces a clean error for malformed JSON (wrong types, missing required fields)
- Process exits with a meaningful error message

**Recommended additional mitigation:**

```rust
// In SimConfig::load():
let config: SimConfig = serde_json::from_str(&raw)?;
config.validate()?;  // Add range checks per field
```

### 3. SQL Injection (Boundary 2—Store)

**Surface:** `SimStore` methods in `core/src/store/`.

**Risk:** SQL injection via user-supplied string values (IPC `complaint_id`, `resolution` strings).

**Mitigations in place:**

- `rusqlite` enforces parameterized queries via the `params![]` macro — no string interpolation into SQL
- `SimStore` is the only place SQL executes (enforced by ADR-002 and code review)

**Status:** No dynamic SQL construction has been identified. Standard parameterized queries throughout.

### 4. Process Escape (IPC bridge)

**Surface:** `ProcessStartInfo` in `SimBridge.cs` spawning `sim-runner.exe`.

**Risk:** Path traversal or argument injection if the exe path were user-controlled.

**Mitigations in place:**

- Path is hardcoded: `ProjectSettings.GlobalizePath("res://sim-runner.exe")` — always relative to the Godot project directory
- Arguments are hardcoded: `"--ticks 0 --ipc-mode"` — no user-supplied arguments

**Status:** No injection vector.

---

## Data Classification

| Data | Classification | Notes |
|------|---------------|-------|
| Simulation customer records | Synthetic only | Generated by `name_generator.rs`; no real PII |
| Transaction amounts | Synthetic | Driven by config probabilities |
| SQLite database (`run_N.db`) | Simulation state only | Safe to delete at end of playthrough |
| `data/*.json` config files | Game parameters | Not sensitive; committed to git |
| Seed value | Low sensitivity | Knowing the seed enables replay — intentional by design |

**Policy:** FinCrime: The Desk must never be configured to ingest, display, or process real customer data, real account numbers, or real transaction records. All simulation entities are procedurally generated.

---

## Dependency Auditing

```bash
# Install cargo-audit
cargo install cargo-audit

# Run advisory scan
cargo audit

# Run in CI (non-blocking, for monitoring)
cargo audit || echo "Advisory scan complete — review output"
```

### Current dependencies (`Cargo.toml` workspace)

| Crate | Version | Notes |
|-------|---------|-------|
| `rusqlite` | 0.31 | Bundled SQLite 3.x |
| `serde` | 1 | Industry standard |
| `serde_json` | 1 | Industry standard |
| `rand` | 0.8 | RNG infrastructure |
| `rand_pcg` | 0.3 | PCG64Mcg generator |
| `uuid` | 1 (v4) | Entity ID generation |
| `chrono` | 0.4 | Only in tools (IPC timestamp) |
| `thiserror` | 1 | Error type derivation |
| `anyhow` | 1 | Error context wrapping |
| `log` | 0.4 | Logging facade |
| `env_logger` | 0.11 | Logger backend |

**Recommendation:** Add `cargo audit` as a weekly CI job or pre-release gate.

---

## Secure Defaults

| Default | Value | Rationale |
|---------|-------|-----------|
| SQLite mode | WAL | Concurrent reads; crash-safe journal |
| RNG | PCG64Mcg seeded at startup | Deterministic; no platform entropy |
| IPC transport | localhost pipe (ProcessStartInfo) | No network socket; process-local only |
| Database path | Explicit `--db` flag required | No accidental shared database |
| Config path | `./data` (relative to process) | Predictable; no environment variable injection |

---

## Future Hardening (If Multiplayer Is Added)

If a Phase 4 enterprise/multiplayer mode is implemented, the following become **critical**:

- **Authentication**: JWT or session tokens on the API boundary
- **Authorization**: per-run ownership checks before any command is applied
- **Input validation**: all `PlayerCommand` fields validated at the API layer, not just in-engine
- **Rate limiting**: ticks-per-second limit to prevent denial-of-service via rapid tick submission
- **TLS**: all network IPC must use TLS; stdout pipes are insufficient for network transport
- **Audit log immutability**: the event_log table should be append-only at the DB user permission level
